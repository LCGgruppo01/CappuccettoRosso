<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Phaser Game!</title>
        <script src="http://cdn.jsdelivr.net/phaser/2.5.0/phaser.min.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        // Phaser code here! :)
        /**
         * Generated from the Phaser Sandbox
         *
         * //phaser.io/sandbox/NynQHaDE
         *
         * This source requires Phaser 2.6.2
         */

        var game = new Phaser.Game(1350, 640, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render });

        var scoreWolves = 10;
        var scoreCandiesText;
        var scoreToothbrushes = 10;
        var scoreToothbrushesText;
        var jump = 500;
        var openImage;
        var candies;
        var toothbrushes;
        var time = 0;
        var gravity = 800;
        var platformLenght = 500;
        var platformHeight = 64;

        function preload() {

        }

        var StartState = {
            preload: function() {
                game.load.crossOrigin = 'anonymous';
                game.load.image('open', 'https://i.imgur.com/r7PzpJB.png');
            },

            create: function() {
                image = game.add.sprite(game.world.centerX, game.world.centerY, 'open');
                image.anchor.set(0.5);
                image.inputEnabled = true;
                image.events.onInputDown.add(this.imageClick, this);
                scoreCandies = 10;
                scoreToothbrushes = 10;
                jump = 200;

            },

            imageClick: function(pointer) {
                this.game.state.start('Game1');
            }

        }

        game.state.add('Start', StartState);

        var Game1State = {
            preload: function() {

                game.world.width = 3000;

                game.load.crossOrigin = 'anonymous';

                game.load.image('bullet', 'https://image.flaticon.com/icons/png/512/226/226507.png');
                game.load.image('candy', 'https://ksr-ugc.imgix.net/assets/021/798/257/c7a78e3b02a0ce16b25e2691b340ca4a_original.gif?ixlib=rb-1.1.0&w=639&fit=max&v=1530734733&auto=format&gif-q=50&q=92&s=bacdaaaaa563a6933b32671b9c9172ad');

                game.load.baseURL = 'http://examples.phaser.io/assets/';

                game.load.image('sky', 'skies/sky2.png');
                game.load.image('ground', 'sprites/platform.png');
                game.load.spritesheet('dude', 'sprites/pacman_by_oz_28x28.png', 28, 28);
            },

            create: function() {
                game.world.setBounds(0, 0, game.world.width*2, game.world.height);
                game.physics.startSystem(Phaser.Physics.ARCADE);
                var cielo=game.add.sprite(0, 0, 'sky');
                cielo.scale.setTo(5, 1);

                scoreWolves = 10;
                var position="rightt";


                platforms = game.add.group();
                platforms.enableBody = true;
                for (i = 0; i < game.world.width / platformLenght; i++) {
                  var ground = platforms.create(i * platformLenght, game.world.height - platformHeight, 'ground');
                  ground.body.immovable = true;
                };

                platforms.enableBody = true;
                for (i = 0; i < game.world.width / platformLenght + 300; i++) {
                  var ledge = platforms.create(i * platformLenght + i * 300 + platformLenght, game.world.height / 2 * Math.random() + game.world.height / 2 - platformHeight, 'ground');
                  ledge.body.immovable = true;
                };

                Wolves = game.add.group();
                Wolves.enableBody = true;

                for (i = 0; i < 15; i++) {
                    var wolf = Wolves.create(game.world.width * Math.random() + 700, game.world.height - platformHeight - 75, 'candy');
                    wolf.body.gravity.y = gravity;
                    wolf.body.bounce.y =0.2;
                    wolf.scale.setTo(0.3, 0.3);
                }

                player = game.add.sprite(32, game.world.height - platformHeight - 28, 'dude');
                game.physics.arcade.enable(player);
                player.body.bounce.y = 0.2;
                player.body.gravity.y = gravity;
                player.body.collideWorldBounds = true;
                player.animations.add('right', [0, 1, 2, 3], 10, true);
                player.animations.add('left', [7, 8, 9, 10], 10, true);

                game.camera.follow(player);


                cursors = game.input.keyboard.createCursorKeys();
                SPACE=game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);

                Bullets = game.add.group();
                Bullets.enableBody = true;


                scoreWolvesText = game.add.text(16, 488, 'Remaining Wolves: 10', { fontSize: '32px', fill: '#FFF' });

            },

            update: function() {
                var hitPlatform = game.physics.arcade.collide(player, platforms);
                game.physics.arcade.collide(Wolves, platforms);
                game.physics.arcade.overlap(player, Wolves, this.loose, null, this);
                game.physics.arcade.overlap(Bullets, platforms, this.elide, null, this);
                game.physics.arcade.overlap(Bullets, Wolves, this.collectWolves, null, this);

                player.scale.setTo(jump/1000+0.5, jump/1000+0.5);

                player.body.velocity.x = 0;

                if (cursors.left.isDown)
                {
                    player.body.velocity.x = -350;
                    player.animations.play('left');
                    position="leftt";

                }
                else if (cursors.right.isDown)
                {
                    player.body.velocity.x = 350;
                    player.animations.play('right');
                    position="rightt";
                }
                else
                {
                    player.animations.stop();
                    player.frame = 5;
                }

                if (cursors.up.isDown && player.body.touching.down && hitPlatform)
                {
                    player.body.velocity.y = -600;
                }

                if (SPACE.isDown && position=="leftt" && game.time.now>time)
                {
                    var bullet = Bullets.create(player.x, player.y-10, 'bullet');
                    bullet.body.velocity.x = -700;
                    bullet.scale.setTo(0.04, 0.04);
                    time=game.time.now+200;

                }
                else if (SPACE.isDown && position=="rightt" && game.time.now>time)
                {
                    bullet = Bullets.create(player.x, player.y-10, 'bullet');
                    bullet.body.velocity.x = 700;
                    bullet.scale.setTo(0.04, 0.04);
                    time=game.time.now+200;

                }

                 Wolves.forEach(function(wolf){

                  if(player.x - wolf.x < 400){
                    wolf.body.velocity.x = (player.x - wolf.x)/Math.abs(player.x - wolf.x)*50;
                  //  if(wolf.y - player.y > 150){
                  //    wolf.body.velocity.y = -700;
                  //  }
                  //  else{
                  //    wolf.body.velocity.y = 0;
                  //  }
                  }
                  else{
                    wolf.body.velocity.x = 0;
                  }

                });
            },

            loose: function (player, wolf) {
                this.game.state.start('Bad');
            },

            elide: function (siElide, rimane) {
                siElide.kill();
            },

            collectWolves: function (bul, wol) {
                wol.kill();
                bul.kill();
                scoreWolves--;
                scoreWolvesText.text = 'Remaining Wolves: ' + scoreWolves;
                if(scoreWolves === 0)
                    this.game.state.start('Good');
            }
        }

        game.state.add('Game1', Game1State);

        var GoodState = {
            preload: function() {
                game.load.crossOrigin = 'anonymous';
                game.load.image('open', 'https://img.freepik.com/free-vector/clean-tooth-background_1270-86.jpg?size=338&ext=jpg');
            },

            create: function() {
                game.world.setBounds(0, 0, game.world.width*0.5, game.world.height);
                image = game.add.sprite(game.world.centerX, game.world.centerY, 'open');
                image.anchor.set(0.5);
                image.inputEnabled = true;
                image.events.onInputDown.add(this.imageClick, this);
            },

            imageClick: function(pointer) {
                this.game.state.start('Start');
            }

        }

        game.state.add('Good', GoodState);

        game.state.add('Game1', Game1State);

        var BadState = {
            preload: function() {
                game.load.crossOrigin = 'anonymous';
                game.load.image('open', 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTy0kSXXPUNRgkBb4PI0wAHSon2mSo2Xj6oojXZ90NZIIBAKIc6');
            },

            create: function() {
                game.world.setBounds(0, 0, game.world.width*0.5, game.world.height);
                image = game.add.sprite(game.world.centerX, game.world.centerY, 'open');
                image.anchor.set(0.5);
                image.inputEnabled = true;
                image.events.onInputDown.add(this.imageClick, this);
            },

            imageClick: function(pointer) {
                this.game.state.start('Start');
            }

        }

        game.state.add('Bad', BadState);

        // start the boot state
        game.state.start('Start');

        function create() {

        }

        function update () {

        }

        function render () {

        }


    }

    </script>

    </body>
</html>
